---
import NavbarLink from './NavbarLink.astro'
import { Icon } from 'astro-icon/components'
import ThemeSelector from './ThemeSelector.astro'
import { siteConfig, WebsiteLinks } from '@/site.config'
import LogoSVG from '../assets/logo.svg'
---

<header class="bg-background/80 dark:bg-background-dark/80 fixed top-0 z-10 w-full backdrop-blur-lg">
	<nav>
		<div class="app-container flex items-center justify-between py-4">
			<a href=`${siteConfig.base}/` aria-label="首頁">
				<LogoSVG height={36} width={36} />
			</a>
			<div class="hidden items-center gap-8 md:flex">
				{
					WebsiteLinks.map((link) => (
						<NavbarLink class="px-1 text-lg" href={`${siteConfig.base}/${link.url}`} target={link.url.charAt(0) === 'h' ? '_blank' : '_self'}>
							{link.name}
						</NavbarLink>
					))
				}
				<ThemeSelector />
			</div>
			<button class="cursor-pointer md:hidden" id="nav-open-btn" aria-label="開啟導覽選單" title="開啟導覽選單">
				<Icon aria-hidden name="mdi:menu" size={32} />
			</button>

			<!-- Mobile nav -->
			<div
				class="bg-background dark:bg-background-dark border-background fixed top-0 right-0 z-40 h-screen w-5/6 translate-x-full border-l px-8 py-6 transition-transform md:hidden"
				id="mobile-menu"
			>
				<button id="nav-close-btn" class="ml-auto block cursor-pointer" aria-label="關閉導覽選單" title="關閉導覽選單">
					<Icon aria-hidden name="mdi:close" size={32} />
				</button>
				<div class="flex h-full flex-col items-start gap-8 pt-16">
					{
						WebsiteLinks.map((link) => (
							<NavbarLink class="text-4xl font-normal" href={`${siteConfig.base}/${link.url}`}>
								{link.name}
							</NavbarLink>
						))
					}
					<ThemeSelector class:list="mt-4" />
				</div>
			</div>
		</div>
	</nav>
	<script>
		function toggleNav() {
			document.querySelector('#mobile-menu')?.classList.toggle('mobile-nav-open')
		}

		document.querySelector('#nav-open-btn')?.addEventListener('click', toggleNav)
		document.querySelector('#nav-close-btn')?.addEventListener('click', toggleNav)

		document.addEventListener('astro:after-swap', () => {
			document.querySelector('#nav-open-btn')?.addEventListener('click', toggleNav)
			document.querySelector('#nav-close-btn')?.addEventListener('click', toggleNav)
		})
	</script>
</header>

<script is:inline>
	function reComputeTheme() {
		if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}

		const theme = localStorage.theme || 'auto'
		document.querySelectorAll(`[data-theme="theme-${theme}"]`).forEach((el) => el.classList.add('active'))
	}

	function addThemeEventListeners() {
		themeButtons = document.querySelectorAll('.theme-button')
		themeButtons.forEach((button) => {
			button.addEventListener('click', () => {
				themeButtons.forEach((btn) => btn.classList.remove('active'))
				button.classList.add('active')
				if (button.dataset.theme === 'theme-auto') {
					localStorage.removeItem('theme')
					reComputeTheme()
				} else {
					localStorage.theme = button.dataset.theme.replace('theme-', '')
					document.documentElement.classList.toggle('dark', button.dataset.theme === 'theme-dark')
				}
			})
		})
	}

	// Set active class on OS theme change
	window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (_e) => {
		reComputeTheme()
	})

	// run recomputeTheme when screen crosses 768px
	window.matchMedia('(min-width: 768px)').addEventListener('change', (_e) => {
		addThemeEventListeners()
		reComputeTheme()
	})

	reComputeTheme()

	// Run on page load
	window.addEventListener('DOMContentLoaded', () => {
		addThemeEventListeners()
		reComputeTheme()
	})

	// Run on page swapped
	document.addEventListener('astro:after-swap', () => {
		addThemeEventListeners()
		reComputeTheme()
	})
</script>
