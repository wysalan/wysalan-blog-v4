---
import { type GetStaticPathsOptions } from 'astro'
import { siteConfig } from '@/site.config'
import { Icon } from 'astro-icon/components'
import { getAllPosts } from '@Utils/postUtils'
import { tagNameSlugify } from '@Utils/tagUtils'
import BaseLayout from '@Layouts/BaseLayout.astro'
import PostBlock from '@Components/common/PostBlock.astro'
import Pagination from '@Components/Pagination.astro'

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
	const allPosts = await getAllPosts()
	const allTags = [...new Set(allPosts.map((post) => post.data.tags).flat())]
	return allTags.flatMap((tag) => {
		const filteredPosts = allPosts.filter((post) => post.data.tags?.flat().includes(tag || ''))
		return paginate(filteredPosts, {
			params: { tags: tagNameSlugify(tag) },
			props: { origTagName: tag },
			pageSize: siteConfig.pageSize,
		})
	})
}

const { page, origTagName } = Astro.props
const { tags } = Astro.params
const { data } = page
---

<BaseLayout title=`標籤：${origTagName} | ${siteConfig.title}`>
	<main class="main-container">
		<div class="flex flex-wrap items-center">
			<Icon name="material-symbols:tag-rounded" class="mr-3" size={38} />
			<h1 class="page-title">{origTagName}</h1>
		</div>
		<section class="main-section">
			<div class="postList">
				{data.map((post) => <PostBlock post={post} />)}
			</div>
		</section>
		<div class="my-10">
			<Pagination page={page} firstPageUrl={`/tags/${tags}`} urlPattern={`/tags/${tags}/page/{}`} />
		</div>
	</main>
</BaseLayout>
